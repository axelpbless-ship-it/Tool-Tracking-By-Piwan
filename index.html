<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tool Tracking by Piwan</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <!-- HEADER -->
  <header class="bg-[#6AA84F] text-white py-4 shadow-md">
    <h1 class="text-center text-2xl font-bold">üì¶ Tool Tracking by Piwan</h1>
  </header>

  <main class="p-6 space-y-8">

    <!-- INVENTARIO -->
    <section>
      <h2 class="text-xl font-semibold mb-4">Inventario</h2>
      <div id="inventory-container" class="grid md:grid-cols-2 gap-4"></div>
    </section>

    <!-- ASIGNACI√ìN -->
    <section class="bg-white p-4 rounded-lg shadow">
      <h2 class="text-lg font-semibold mb-4">Asignaci√≥n de Herramientas</h2>
      <form id="assign-item-form" class="space-y-3">
        <input type="text" id="assign-barcode-input" placeholder="Escanear o escribir c√≥digo" class="w-full border rounded px-3 py-2">
        <select id="assign-operario" class="w-full border rounded px-3 py-2">
          <option value="">-- Seleccione Operario --</option>
          <option value="Juan">Juan</option>
          <option value="Ana">Ana</option>
          <option value="Pedro">Pedro</option>
        </select>
        <div id="scanned-items-summary" class="space-y-1"></div>
        <p id="empty-scan-message" class="text-sm text-gray-500">No hay art√≠culos escaneados.</p>
        <p class="text-sm">Escaneados: <span id="scanned-count">0</span></p>
        <button type="submit" id="confirm-assign-btn" disabled
          class="w-full py-3 px-4 rounded-lg shadow text-white font-semibold bg-[#6AA84F] hover:bg-[#4d9735] disabled:bg-gray-400">
          Confirmar Asignaci√≥n
        </button>
      </form>
    </section>

    <!-- DEVOLUCI√ìN -->
    <section class="bg-white p-4 rounded-lg shadow">
      <h2 class="text-lg font-semibold mb-4">Devoluci√≥n de Herramientas</h2>
      <form id="devolucion-item-form" class="space-y-3">
        <input type="text" id="devolucion-barcode-input" placeholder="Escanear C√≥digo de Producto Devuelto"
          class="w-full border rounded px-3 py-2">
        <p id="devolucion-scan-error" class="hidden text-red-500 text-sm">‚ùå Error en escaneo.</p>
        <select id="devolucion-status" class="w-full border rounded px-3 py-2">
          <option value="">-- Estado del producto --</option>
          <option value="Bueno">Bueno</option>
          <option value="Reparable">Reparable</option>
          <option value="Irreparable">Irreparable</option>
        </select>
        <div id="devolucion-items-summary" class="space-y-1"></div>
        <p id="empty-devolucion-message" class="text-sm text-gray-500">No hay art√≠culos escaneados.</p>
        <p class="text-sm">Escaneados: <span id="devolucion-scanned-count">0</span> / <span id="devolucion-total-count">0</span></p>
        <button type="submit" id="confirm-devolucion-btn" disabled
          class="w-full py-3 px-4 rounded-lg shadow text-white font-semibold bg-[#6AA84F] hover:bg-[#4d9735] disabled:bg-gray-400">
          Confirmar Devoluci√≥n y Actualizar Estado
        </button>
      </form>
    </section>

    <!-- BIT√ÅCORA -->
    <section>
      <h2 class="text-lg font-semibold mb-2">Bit√°cora</h2>
      <ul id="bitacora-list" class="bg-white p-3 rounded-lg shadow space-y-2 text-sm"></ul>
    </section>

  </main>

  <script>
    // --- SIMULACI√ìN DE DATOS ---
    let inventoryData = [
      { id: "A001", name: "Martillo", total: 5, available: 5 },
      { id: "A002", name: "Taladro", total: 3, available: 3 },
      { id: "A003", name: "Sierra", total: 2, available: 2 }
    ];
    let loansData = [];
    let bitacoraData = [];
    let scannedItemsForAssignment = [];
    let scannedItemsForDevolucion = [];
    let currentLoanForDevolucion = { items: [], totalItems: 0, operarioName: "OperarioX" };
    let currentUserRole = "admin";

    // --- UTILS ---
    function showMessage(msg, type) {
      console.log(`[${type}] ${msg}`);
    }
    function loadAllData() {
      renderInventory();
      renderBitacora();
    }

    // --- RENDER INVENTARIO ---
    function renderInventory() {
      const container = document.getElementById("inventory-container");
      container.innerHTML = "";
      inventoryData.forEach(item => {
        const card = document.createElement("div");
        card.className = "p-3 bg-white rounded-lg shadow flex justify-between";
        card.innerHTML = `
          <p><b>${item.name}</b> (ID: ${item.id})</p>
          <p>${item.available} disponibles / ${item.total} total</p>
        `;
        container.appendChild(card);
      });
    }

    // --- RENDER BIT√ÅCORA ---
    function renderBitacora() {
      const list = document.getElementById("bitacora-list");
      list.innerHTML = "";
      bitacoraData.slice(-10).reverse().forEach(entry => {
        const li = document.createElement("li");
        li.className = "border-b pb-1";
        li.textContent = `${entry.date} - ${entry.type}: ${entry.detail}`;
        list.appendChild(li);
      });
    }

    // --- ASIGNACI√ìN ---
    document.getElementById("assign-item-form").addEventListener("submit", e => {
      e.preventDefault();
      const operario = document.getElementById("assign-operario").value;
      if (!operario || scannedItemsForAssignment.length === 0) {
        return showMessage("Debe seleccionar operario y al menos un art√≠culo.", "error");
      }
      scannedItemsForAssignment.forEach(item => {
        loansData.push({ id: Date.now(), itemId: item.id, itemName: item.name, operarioName: operario });
        bitacoraData.push({ date: new Date().toLocaleString(), type: "Asignaci√≥n", detail: `${item.name} ‚Üí ${operario}` });
      });
      showMessage("Asignaci√≥n confirmada.", "success");
      scannedItemsForAssignment = [];
      updateAssignmentSummary();
      loadAllData();
    });

    function updateAssignmentSummary() {
      const summaryContainer = document.getElementById("scanned-items-summary");
      const scannedCount = document.getElementById("scanned-count");
      const confirmBtn = document.getElementById("confirm-assign-btn");
      const operario = document.getElementById("assign-operario").value;

      scannedCount.textContent = scannedItemsForAssignment.length;
      summaryContainer.innerHTML = "";

      if (scannedItemsForAssignment.length === 0) {
        document.getElementById("empty-scan-message").classList.remove("hidden");
        confirmBtn.disabled = true;
        return;
      } else {
        document.getElementById("empty-scan-message").classList.add("hidden");
      }
      confirmBtn.disabled = !(scannedItemsForAssignment.length > 0 && operario !== "");
      scannedItemsForAssignment.forEach(item => {
        const div = document.createElement("div");
        div.textContent = `${item.name} (ID: ${item.id})`;
        summaryContainer.appendChild(div);
      });
    }
    document.getElementById("assign-operario").addEventListener("change", updateAssignmentSummary);

    // --- DEVOLUCI√ìN ---
    document.getElementById("devolucion-item-form").addEventListener("submit", e => {
      e.preventDefault();
      if (scannedItemsForDevolucion.length === 0) return showMessage("Debe escanear art√≠culos.", "error");
      const status = document.getElementById("devolucion-status").value;
      if (!status) return showMessage("Debe seleccionar un estado.", "error");

      scannedItemsForDevolucion.forEach(item => {
        const inv = inventoryData.find(i => i.id === item.itemId);
        if (inv) inv.available++;
        bitacoraData.push({ date: new Date().toLocaleString(), type: "Devoluci√≥n", detail: `${item.itemName} devuelto. Estado: ${status}` });
      });
      showMessage("Devoluci√≥n confirmada.", "success");
      scannedItemsForDevolucion = [];
      updateDevolucionSummary();
      loadAllData();
    });

    function updateDevolucionSummary() {
      const summaryContainer = document.getElementById("devolucion-items-summary");
      const scannedCount = document.getElementById("devolucion-scanned-count");
      const totalCount = document.getElementById("devolucion-total-count");
      const confirmBtn = document.getElementById("confirm-devolucion-btn");
      const status = document.getElementById("devolucion-status").value;

      scannedCount.textContent = scannedItemsForDevolucion.length;
      totalCount.textContent = currentLoanForDevolucion.totalItems;
      summaryContainer.innerHTML = "";

      if (scannedItemsForDevolucion.length === 0) {
        document.getElementById("empty-devolucion-message").classList.remove("hidden");
        confirmBtn.disabled = true;
        return;
      } else {
        document.getElementById("empty-devolucion-message").classList.add("hidden");
      }
      confirmBtn.disabled = !(scannedItemsForDevolucion.length > 0 && status !== "");
      scannedItemsForDevolucion.forEach(item => {
        const div = document.createElement("div");
        div.textContent = `${item.itemName} (ID: ${item.itemId})`;
        summaryContainer.appendChild(div);
      });
    }
    document.getElementById("devolucion-status").addEventListener("change", updateDevolucionSummary);

    // --- INIT ---
    loadAllData();
  </script>
</body>
</html>
